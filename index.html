<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Word Prediction Game</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    #game, #ctx { display: none; }
    .slider-row { margin: .5rem 0; }
    .slider-row label { width: 80px; display: inline-block; }
  </style>
</head>
<body>

  <!-- LOGIN FORM -->
  <div id="login">
    <h2>Login</h2>
    <input id="user" placeholder="Username"><br><br>
    <input id="pass" type="password" placeholder="Password"><br><br>
    <button id="btnLogin">Log In</button>
    <p id="err" style="color:red;"></p>
  </div>

  <!-- GAME UI -->
  <div id="game">
    <h2>Word Prediction</h2>
    <pre id="ctx"></pre>
    <div id="sliders"></div>
    <button id="btnSubmit">Submit Guess</button>
  </div>

  <script>
  (() => {
    const SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL';
    let state = { row: null, logsum: 0, played:0, skipped:0 };

    document.getElementById('btnLogin').onclick = async () => {
      const user = document.getElementById('user').value;
      const pass = document.getElementById('pass').value;
      const res  = await fetch(SCRIPT_URL, {
        method:'POST',
        body: JSON.stringify({ action:'login', user, pass }),
        headers:{ 'Content-Type':'application/json' }
      }).then(r=>r.json());

      if (!res.success) {
        return document.getElementById('err').innerText = 'Login failed';
      }
      // stash state and launch game
      Object.assign(state, res);
      document.getElementById('login').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      startTrial();
    };

    // load corpus
    let words = [];
    fetch('text.txt')
      .then(r=>r.text())
      .then(txt => {
        words = txt
          .split(/\s+/)
          .map(w => w.replace(/[\W_]+/g,'').toLowerCase())
          .filter(w=>w);
      });

    // GAME PARAMETERS
    const MAX_TRIALS = 10, CTX = 50, CAND = 5;
    let trial=0, trueWord;

    function startTrial(){
      if (trial >= MAX_TRIALS) return endGame();

      // pick context + true
      const idx = Math.floor(Math.random()*(words.length-CTX-1));
      const ctxWords = words.slice(idx, idx+CTX);
      trueWord = words[idx+CTX];
      document.getElementById('ctx').innerText = ctxWords.join(' ');
      buildSliders();
    }

    function buildSliders(){
      const container = document.getElementById('sliders');
      container.innerHTML = '';
      // pick candidates
      const others = Array.from(new Set(words))
                        .filter(w=>w!==trueWord);
      const cands = shuffle(others).slice(0,CAND-1)
                        .concat(trueWord);
      shuffle(cands);

      cands.forEach(w => {
        const row = document.createElement('div');
        row.className = 'slider-row';
        const lbl = document.createElement('label');
        lbl.textContent = w;
        const inp = document.createElement('input');
        inp.type = 'range';
        inp.min = 0; inp.max = 100;
        inp.value = 100/CAND;
        inp.oninput = normalize;
        row.append(lbl, inp);
        container.append(row);
      });
    }

    function normalize(){
      const inputs = [...document.querySelectorAll('#sliders input')];
      const sum = inputs.reduce((s,i)=>s+ +i.value, 0);
      if (sum === 0) {
        inputs.forEach(i=> i.value = 100/CAND);
        return;
      }
      inputs.forEach(i=> i.value = i.value/sum*100);
    }

    document.getElementById('btnSubmit').onclick = () => {
      const inputs = [...document.querySelectorAll('#sliders input')];
      const labels = [...document.querySelectorAll('#sliders label')];
      const probs = {};
      inputs.forEach((i,j)=> probs[labels[j].textContent] = i.value/100);

      const p = probs[trueWord] || 0;
      if (p > 0) {
        state.logsum += Math.log(p);
        state.played++;
      } else {
        state.skipped++;
        return updateSheet('skipped');
      }
      trial++;
      updateSheet('played', Math.exp(state.logsum/state.played));
    };

    async function updateSheet(result, newLogMean=0) {
      // send update
      await fetch(SCRIPT_URL, {
        method:'POST',
        body: JSON.stringify({
          action: result==='played' ? 'update' : 'update',
          row:    state.row,
          result,
          incrementRounds: state.played,
          newLogSum:       state.logsum,
          incrementSkipped: state.skipped
        }),
        headers:{ 'Content-Type':'application/json' }
      });
      if (trial >= MAX_TRIALS || result==='skipped') return endGame();
      startTrial();
    }

    function endGame(){
      alert(`Game over!  
Average prob score: ${ (state.logsum> -Infinity) ? Math.exp(state.logsum/state.played).toFixed(4) : '0.0000' }`);
      document.getElementById('btnSubmit').disabled = true;
    }

    // simple Fisherâ€“Yates
    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

  })();
  </script>
</body>
</html>
